<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>日月抽签机 · sunmoon-orbit</title>
  <meta name="theme-color" content="#E8E4DE" />

  <style>
    :root{
      --bg:#E8E4DE;
      --card:#F5F2EE;
      --ink:#2E2E2E;
      --muted:#6E6A63;
      --line:#D7D1C9;

      --a:#A3B18A;     /* 雾绿 */
      --b:#B7A99A;     /* 灰棕 */
      --c:#9AA6B2;     /* 雾蓝灰 */
      --d:#CBBFAF;     /* 米杏 */
      --shadow: 0 10px 30px rgba(25,25,25,.08);
      --r:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC","Noto Sans CJK SC","Microsoft YaHei", sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, #F3F0EB 0%, var(--bg) 55%, #E3DDD6 100%);
      color:var(--ink);
      overflow-x:hidden;
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 32px;
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin: 8px 0 14px;
    }
    .brand{ display:flex; flex-direction:column; gap:6px; }
    .title{ font-size: 20px; font-weight: 740; letter-spacing: .4px; }
    .sub{ font-size: 12px; color: var(--muted); line-height:1.4; }

    .pill{
      display:flex;
      gap:8px;
      align-items:center;
      padding:10px 12px;
      background: rgba(245,242,238,.7);
      border: 1px solid var(--line);
      border-radius: 999px;
      box-shadow: 0 2px 10px rgba(20,20,20,.04);
      user-select:none;
    }
    .pill span{ font-size:12px; color:var(--muted); white-space:nowrap; }
    .switch{
      width:46px;height:26px;border-radius:999px;
      background:#E1DBD3;
      border:1px solid var(--line);
      position:relative;
      cursor:pointer;
      flex:0 0 auto;
    }
    .knob{
      width:22px;height:22px;border-radius:999px;
      background: linear-gradient(180deg,#fff,#F2EEE8);
      box-shadow: 0 6px 14px rgba(0,0,0,.12);
      position:absolute; top:1px; left:1px;
      transition: transform .18s ease;
    }
    .switch.on{ background: #DDE6D6; border-color:#CAD8BF; }
    .switch.on .knob{ transform: translateX(20px); }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
    }
    @media (max-width: 860px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: rgba(245,242,238,.78);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 14px;
      backdrop-filter: blur(6px);
    }

    .tabs{ display:flex; gap:10px; flex-wrap:wrap; padding: 4px 2px 8px; }
    .tab{
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.35);
      color: var(--muted);
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, background .16s ease;
    }
    .tab:active{ transform: scale(.98); }
    .tab.active{
      color: var(--ink);
      background: linear-gradient(180deg, rgba(255,255,255,.72), rgba(245,242,238,.55));
      border-color: rgba(46,46,46,.14);
    }

    .stage{
      position:relative;
      min-height: 320px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 10px 0 0;
    }
    .slip{
      width:min(520px, 92%);
      border-radius: 20px;
      border:1px solid rgba(46,46,46,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.75), rgba(245,242,238,.65));
      box-shadow: 0 14px 35px rgba(0,0,0,.10);
      padding: 18px 16px;
      text-align:center;
      position:relative;
      transform: translateY(-6px);
    }
    .slip::before{
      content:"";
      position:absolute; left:16px; right:16px; top:10px;
      height: 10px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(163,177,138,.55), rgba(154,166,178,.55), rgba(183,169,154,.55));
      opacity:.65;
    }
    .slip h2{ margin: 14px 0 8px; font-size: 18px; letter-spacing:.2px; }
    .slip p{ margin:0; color: var(--muted); font-size: 12px; line-height: 1.5; }
    .result{
      margin-top: 14px;
      font-size: 22px;
      font-weight: 760;
      line-height: 1.25;
      padding: 10px 8px 2px;
      word-break: break-word;
    }

    .btnrow{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    button{
      appearance:none;
      border: 1px solid rgba(46,46,46,.16);
      background: rgba(255,255,255,.55);
      color: var(--ink);
      border-radius: 14px;
      padding: 11px 14px;
      font-weight: 650;
      cursor:pointer;
      transition: transform .06s ease, box-shadow .14s ease, background .14s ease;
      box-shadow: 0 8px 22px rgba(0,0,0,.06);
    }
    button:active{ transform: scale(.985); }
    .primary{
      border-color: rgba(46,46,46,.18);
      background: linear-gradient(180deg, rgba(163,177,138,.35), rgba(245,242,238,.55));
    }
    .ghost{ background: rgba(245,242,238,.55); color: var(--muted); box-shadow:none; }

    .pop{ animation: pop .24s ease-out; }
    @keyframes pop{
      from{ transform: translateY(-18px) scale(.98); opacity:.0; }
      to{ transform: translateY(-6px) scale(1); opacity:1; }
    }
    .shake{ animation: shake .32s ease-in-out; }
    @keyframes shake{
      0%{ transform: translateY(-6px) rotate(0deg); }
      25%{ transform: translateY(-6px) rotate(-1.2deg); }
      50%{ transform: translateY(-6px) rotate(1.1deg); }
      75%{ transform: translateY(-6px) rotate(-.7deg); }
      100%{ transform: translateY(-6px) rotate(0deg); }
    }

    .side h3{ margin: 0 0 10px; font-size: 14px; color: var(--ink); }
    .small{ font-size: 12px; color: var(--muted); line-height: 1.55; margin: 6px 0 0; }
    .history{
      display:flex; flex-direction:column; gap:8px;
      margin-top: 10px; max-height: 320px; overflow:auto; padding-right: 6px;
    }
    .item{
      border:1px solid var(--line);
      background: rgba(255,255,255,.35);
      border-radius: 14px;
      padding: 10px 10px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .item b{ font-size: 13px; }
    .meta{ font-size: 11px; color: var(--muted); display:flex; gap:8px; flex-wrap:wrap; }

    .editor{
      margin-top: 14px;
      border-top: 1px dashed rgba(46,46,46,.18);
      padding-top: 12px;
    }
    textarea{
      width:100%;
      min-height: 150px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.40);
      padding: 10px 10px;
      font-size: 13px;
      line-height: 1.5;
      outline:none;
      color: var(--ink);
      resize: vertical;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.32);
      font-size: 12px;
      color: var(--muted);
      user-select:none;
    }
    .dot{ width:10px;height:10px;border-radius:50%; background: var(--a); box-shadow: 0 0 0 4px rgba(163,177,138,.18); }
    .dot.b{ background: var(--c); box-shadow: 0 0 0 4px rgba(154,166,178,.18);}
    .dot.c{ background: var(--b); box-shadow: 0 0 0 4px rgba(183,169,154,.18);}
    .dot.d{ background: var(--d); box-shadow: 0 0 0 4px rgba(203,191,175,.18);}
    footer{ margin-top: 14px; color: var(--muted); font-size: 11px; text-align:center; opacity:.9; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="title">日月抽签机</div>
        <div class="sub">选择主题，抽一条签。支持权重、可自定义签条、保存历史记录（仅本地）。</div>
      </div>

      <div class="pill" title="开启后会按权重随机；关闭后为均匀随机">
        <span>权重</span>
        <div id="weightSwitch" class="switch" role="switch" aria-checked="true">
          <div class="knob"></div>
        </div>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="tabs" id="tabs"></div>

        <div class="stage">
          <div class="slip" id="slip">
            <h2 id="deckTitle">抽签</h2>
            <p id="deckDesc">选一个主题，然后点“抽一次”。</p>
            <div class="result" id="result">（还没抽）</div>

            <div class="btnrow">
              <button class="primary" id="drawBtn">抽一次</button>
              <button class="ghost" id="copyBtn">复制结果</button>
              <button class="ghost" id="rerollBtn">再抽一次</button>
            </div>
          </div>
        </div>
      </section>

      <aside class="card side">
        <h3>历史记录</h3>
        <div class="small">历史记录只保存在你的设备中。</div>

        <div class="history" id="history"></div>

        <div class="row">
          <button class="ghost" id="clearHistory">清空历史</button>
          <button class="ghost" id="resetAll">恢复默认签条</button>
        </div>

        <div class="editor">
          <h3>编辑当前签条</h3>
          <div class="small">
            每行一条。可选权重写法：<br/>
            <b>贴贴 | 5</b>（数字越大越容易抽到）<br/>
            不写权重默认 1。
          </div>
          <textarea id="editor" spellcheck="false"></textarea>
          <div class="row">
            <button class="primary" id="saveDeck">保存签条</button>
            <span class="tag"><span class="dot"></span>雾绿</span>
            <span class="tag"><span class="dot b"></span>雾蓝灰</span>
            <span class="tag"><span class="dot c"></span>灰棕</span>
            <span class="tag"><span class="dot d"></span>米杏</span>
          </div>
        </div>

        <footer>sunmoon-orbit · draw</footer>
      </aside>
    </div>
  </div>

<script>
const DEFAULT_DECKS = {
  "晚安语": {
    desc: "睡前抽一句，给今天一个温柔的收尾。",
    items: [
      { t: "今天辛苦啦，明天再继续。", w: 3 },
      { t: "晚安，做个软软的梦。", w: 3 },
      { t: "把心放慢一点，再慢一点。", w: 2 },
      { t: "现在只需要休息。", w: 3 },
      { t: "愿你醒来时更轻松。", w: 2 }
    ]
  },
  "夸夸": {
    desc: "抽一条小夸夸。",
    items: [
      { t: "你很认真地在生活。", w: 3 },
      { t: "你今天做得很好。", w: 3 },
      { t: "你很温柔，也很坚定。", w: 2 },
      { t: "你值得被好好对待。", w: 2 },
      { t: "你比自己以为的更稳。", w: 2 }
    ]
  },
  "今天只做一件小事": {
    desc: "只做一件，也很好。",
    items: [
      { t: "喝一杯水。", w: 3 },
      { t: "把桌面收拾 3 分钟。", w: 2 },
      { t: "把明天要用的东西放好。", w: 2 },
      { t: "出门走 8 分钟。", w: 2 },
      { t: "写下一句今天的感受。", w: 2 },
      { t: "早点睡。", w: 3 }
    ]
  },
  "随机小游戏": {
    desc: "抽一个小互动。",
    items: [
      { t: "猜数字：我心里有 1-20，猜 3 次。", w: 2 },
      { t: "真心话：今天最想听到的一句话是？", w: 2 },
      { t: "二选一：甜的还是咸的？", w: 2 },
      { t: "5 分钟：找一首歌循环听。", w: 2 },
      { t: "快速问答：现在最想做的一件事是？", w: 2 },
      { t: "给自己一个 10 秒的拥抱。", w: 3 }
    ]
  }
};

const KEY_DECKS = "sunmoon_orbit_decks_v2";
const KEY_WEIGHT = "sunmoon_orbit_weight_on_v2";
const KEY_HISTORY = "sunmoon_orbit_history_v2";

function nowText(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function loadDecks(){
  try{
    const raw = localStorage.getItem(KEY_DECKS);
    if(!raw) return structuredClone(DEFAULT_DECKS);
    const parsed = JSON.parse(raw);
    if(!parsed || typeof parsed !== "object") return structuredClone(DEFAULT_DECKS);
    return parsed;
  }catch{
    return structuredClone(DEFAULT_DECKS);
  }
}
function saveDecks(decks){ localStorage.setItem(KEY_DECKS, JSON.stringify(decks)); }

function loadWeightOn(){
  const v = localStorage.getItem(KEY_WEIGHT);
  return v === null ? true : v === "1";
}
function saveWeightOn(on){ localStorage.setItem(KEY_WEIGHT, on ? "1" : "0"); }

function loadHistory(){
  try{
    const raw = localStorage.getItem(KEY_HISTORY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch{
    return [];
  }
}
function saveHistory(list){ localStorage.setItem(KEY_HISTORY, JSON.stringify(list.slice(0,80))); }

function pickOne(items, useWeight){
  if(!items.length) return null;
  if(!useWeight) return items[Math.floor(Math.random()*items.length)];

  let sum = 0;
  for(const it of items){
    const w = Math.max(0, Number(it.w ?? 1));
    sum += w || 0;
  }
  if(sum <= 0) return items[Math.floor(Math.random()*items.length)];

  let r = Math.random() * sum;
  for(const it of items){
    const w = Math.max(0, Number(it.w ?? 1)) || 0;
    r -= w;
    if(r <= 0) return it;
  }
  return items[items.length-1];
}

let decks = loadDecks();
let deckNames = Object.keys(decks);
let current = deckNames[0] || "抽签";
let useWeight = loadWeightOn();
let history = loadHistory();

const tabsEl = document.getElementById("tabs");
const deckTitleEl = document.getElementById("deckTitle");
const deckDescEl = document.getElementById("deckDesc");
const resultEl = document.getElementById("result");
const slipEl = document.getElementById("slip");

const editorEl = document.getElementById("editor");
const historyEl = document.getElementById("history");
const weightSwitch = document.getElementById("weightSwitch");

function renderTabs(){
  tabsEl.innerHTML = "";
  deckNames = Object.keys(decks);
  deckNames.forEach(name=>{
    const btn = document.createElement("div");
    btn.className = "tab" + (name===current ? " active" : "");
    btn.textContent = name;
    btn.onclick = ()=>{ current = name; renderAll(); };
    tabsEl.appendChild(btn);
  });
}

function deckToText(name){
  const d = decks[name];
  if(!d || !Array.isArray(d.items)) return "";
  return d.items.map(it=>{
    const w = Number(it.w ?? 1);
    return (w && w !== 1) ? `${it.t} | ${w}` : `${it.t}`;
  }).join("\n");
}

function parseTextToDeck(text){
  const lines = text.split("\n").map(x=>x.trim()).filter(Boolean);
  const items = [];
  for(const line of lines){
    const parts = line.split("|").map(x=>x.trim());
    const t = parts[0];
    let w = 1;
    if(parts.length >= 2){
      const n = Number(parts[1]);
      if(Number.isFinite(n) && n > 0) w = n;
    }
    if(t) items.push({t, w});
  }
  return items;
}

function renderDeckHeader(){
  const d = decks[current];
  deckTitleEl.textContent = current;
  deckDescEl.textContent = d?.desc || "选一个主题，然后点“抽一次”。";
  editorEl.value = deckToText(current);
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

function renderHistory(){
  historyEl.innerHTML = "";
  const list = history.slice(0, 30);
  if(!list.length){
    const empty = document.createElement("div");
    empty.className = "small";
    empty.style.marginTop = "10px";
    empty.textContent = "还没有历史记录。";
    historyEl.appendChild(empty);
    return;
  }
  for(const h of list){
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <b>${escapeHtml(h.text)}</b>
      <div class="meta">
        <span>${escapeHtml(h.deck)}</span>
        <span>${escapeHtml(h.time)}</span>
        <span>${h.weighted ? "权重" : "均匀"}</span>
      </div>
    `;
    historyEl.appendChild(div);
  }
}

function setSwitchUI(){
  weightSwitch.classList.toggle("on", useWeight);
  weightSwitch.setAttribute("aria-checked", useWeight ? "true" : "false");
}

function renderAll(){
  renderTabs();
  renderDeckHeader();
  renderHistory();
  setSwitchUI();
}

function animate(cls){
  slipEl.classList.remove("pop","shake");
  void slipEl.offsetWidth;
  slipEl.classList.add(cls);
}

function doDraw(){
  const d = decks[current];
  const picked = pickOne(d?.items || [], useWeight);
  if(!picked){
    resultEl.textContent = "（这组签条是空的）";
    animate("shake");
    return;
  }
  resultEl.textContent = picked.t;
  animate("pop");

  history.unshift({ deck: current, text: picked.t, time: nowText(), weighted: useWeight });
  history = history.slice(0, 80);
  saveHistory(history);
  renderHistory();
}

document.getElementById("drawBtn").onclick = doDraw;
document.getElementById("rerollBtn").onclick = doDraw;

document.getElementById("copyBtn").onclick = async ()=>{
  const text = resultEl.textContent.trim();
  if(!text || text === "（还没抽）") return;
  try{
    await navigator.clipboard.writeText(text);
    animate("shake");
  }catch{
    alert("复制失败：当前浏览器不支持复制。");
  }
};

weightSwitch.onclick = ()=>{
  useWeight = !useWeight;
  saveWeightOn(useWeight);
  setSwitchUI();
};

document.getElementById("saveDeck").onclick = ()=>{
  const items = parseTextToDeck(editorEl.value);
  decks[current].items = items;
  saveDecks(decks);
  animate("shake");
};

document.getElementById("clearHistory").onclick = ()=>{
  history = [];
  saveHistory(history);
  renderHistory();
};

document.getElementById("resetAll").onclick = ()=>{
  decks = structuredClone(DEFAULT_DECKS);
  saveDecks(decks);
  deckNames = Object.keys(decks);
  current = deckNames[0];
  renderAll();
  resultEl.textContent = "（还没抽）";
};

/* 小彩蛋：连续点标题 5 次 */
let tap = 0, tapTimer = null;
document.querySelector(".title").addEventListener("click", ()=>{
  tap++;
  clearTimeout(tapTimer);
  tapTimer = setTimeout(()=> tap = 0, 650);
  if(tap >= 5){
    tap = 0;
    resultEl.textContent = "彩蛋：贴贴一下 (๑•̀ㅂ•́)و";
    animate("pop");
  }
});

renderAll();
</script>
</body>
</html>
